<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">Sometimes the connection between Nginx and ELB is intermittent.</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br style="box-sizing: border-box;"></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">If you see the error code for that issue</p><pre class="" style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 11px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.42857; color: rgb(51, 51, 51); word-break: normal; word-wrap: normal; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-radius: 4px;"><code class="language-bash" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-radius: 0px; white-space: inherit;">connect() failed (113: No route to host) while connecting to upstream,</code></pre><p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">The above error occurs because the ELB's IP is periodically changed and Nginx's Connect error occurs.</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br /></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">Therefore, Nginx Restart only fixes the issue when the issue occurs, but it is a temporary method, and even if you solve it, you can see that the error occurs again.</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br /></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">AWS's VPC always has a DNS server that ends in 0.2. If the CIDR is 172.32.0.0/16 when the VPC is created, the DNS is 172.32.0.2</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br style="box-sizing: border-box;"></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">Add this setting to nginx.conf</p><pre class="" style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 11px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.42857; color: rgb(51, 51, 51); word-break: normal; word-wrap: normal; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-radius: 4px;"><code class="language-bash" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-radius: 0px; white-space: inherit;">resolver 172.32.0.2 valid=10s;</code></pre><p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br style="box-sizing: border-box;"></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">Note that proxy_pass must be defined as a variable. If you do not define it as a variable, it will resolve only once, and then you will get the same symptoms.</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br style="box-sizing: border-box;"></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">The final settings are as follows</p><pre class="" style="box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 11px; padding: 9.5px; margin-top: 0px; margin-bottom: 10px; line-height: 1.42857; color: rgb(51, 51, 51); word-break: normal; word-wrap: normal; background-color: rgb(245, 245, 245); border: 1px solid rgb(204, 204, 204); border-radius: 4px;"><code class="language-bash" style="box-sizing: border-box; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: inherit; padding: 0px; color: inherit; background-color: transparent; border-radius: 0px; white-space: inherit;">server {
      keepalive_timeout 10;
      listen       80;
      location / {
                resolver 172.32.0.2 valid=10s;
                set $backend "http://[ELB URL]";
                proxy_pass $backend;
                charset utf-8;
        }</code></pre>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br style="box-sizing: border-box;"></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">
If you make the setting, you can solve the problem caused by connecting through DNS.</p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;"><br /></p>
<p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; font-family: &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Apple SD Gothic Neo&quot;, &quot;Malgun Gothic&quot;, Dotdum; font-size: 14px;">Below is packet monitoring through Suricata. In the above configuration, the following logs periodically remain because it checks the ELB's IP from DNS. There is no problem.</p><pre class="" style="padding: 9.5px; background-color: rgb(245, 245, 245); box-sizing: border-box; overflow: auto; font-family: Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-size: 11px; margin-top: 0px; margin-bottom: 10px; line-height: 1.42857; color: rgb(51, 51, 51); word-break: normal; word-wrap: normal; border: 1px solid rgb(204, 204, 204); border-radius: 4px;"><p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240008:2] SURICATA DNS flow memcap reached [Classification: (null)] [Priority: 3] {UDP} 172.32.18.213:33230 -&gt; 172.32.0.2:53</span></font></p>
<p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240008:2] SURICATA DNS flow memcap reached [Classification: (null)] [Priority: 3] {UDP} 172.32.18.213:33230 -&gt; 172.32.0.2:53</span></font></p>
<p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240008:2] SURICATA DNS flow memcap reached [Classification: (null)] [Priority: 3] {UDP} 172.32.18.213:33230 -&gt; 172.32.0.2:53</span></font></p>
<p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240008:2] SURICATA DNS flow memcap reached [Classification: (null)] [Priority: 3] {UDP} 172.32.18.213:33230 -&gt; 172.32.0.2:53</span></font></p>
<p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240001:1] SURICATA DNS Unsollicited response [Classification: (null)] [Priority: 3] {UDP} 172.32.0.2:53 -&gt; 172.32.18.213:33230</span></font></p>
<p style="margin-bottom: 10px; color: rgb(0, 0, 0); font-family: &quot;맑은 고딕&quot;, sans-serif; font-size: 13px; white-space: normal; box-sizing: border-box;"><font face="Helvetica Neue, Helvetica, Arial, Apple SD Gothic Neo, Malgun Gothic, Dotdum"><span style="font-size: 14px;">Jul 30 22:49:11 ip-172-32-18-213 suricata[2991]: [1:2240001:1] SURICATA DNS Unsollicited response [Classification: (null)] [Priority: 3] {UDP} 172.32.0.2:53 -&gt; 172.32.18.213:33230</span></font></p></pre><p style="box-sizing: border-box; margin-right: 0px; margin-bottom: 10px;"><br /></p>
